<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ä¹˜æ³•å°é»é»</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f7fb;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    .game-wrapper {
      margin-top: 40px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
      padding: 24px 28px 28px;
      max-width: 520px;
      width: 90%;
    }

    h1 {
      font-size: 24px;
      margin: 0 0 4px;
      text-align: center;
    }

    .subtitle {
      text-align: center;
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }

    .stats {
      text-align: center;
      font-size: 13px;
      color: #555;
      margin-bottom: 6px;
    }

    .stats span {
      font-weight: 600;
    }

    /* çå‹µå€ */
    .reward-panel {
      background: #f7f8ff;
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 13px;
      margin-bottom: 10px;
      border: 1px solid #dde3ff;
    }

    .reward-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin: 2px 0;
      flex-wrap: wrap;
    }

    .reward-label {
      font-weight: 600;
      color: #444;
      min-width: 76px;
    }

    .star-track {
      display: flex;
      gap: 2px;
      flex-wrap: nowrap;
    }

    .star {
      font-size: 16px;
      color: #d0d4e6;
    }

    .star.on {
      color: #ffb400;
      text-shadow: 0 0 3px rgba(255, 180, 0, 0.7);
    }

    .star-count-text {
      font-size: 12px;
      color: #555;
      white-space: nowrap;
    }

    .badge-list {
      font-size: 18px;
    }

    .badge-empty {
      font-size: 12px;
      color: #888;
    }

    .mode-switch {
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }

    .mode-btn {
      border-radius: 999px;
      border: 1px solid #d0d7ff;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      background: #f3f5ff;
      color: #3949ab;
      transition: background 0.1s ease, color 0.1s ease, box-shadow 0.1s ease;
    }

    .mode-btn.active {
      background: #4b7bec;
      color: #fff;
      border-color: #4b7bec;
      box-shadow: 0 2px 8px rgba(75, 123, 236, 0.5);
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 8px;
      margin-top: 4px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      background: #4b7bec;
      color: white;
      transition: transform 0.05s ease, box-shadow 0.1s ease, background 0.1s ease;
    }

    button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.15) inset;
      background: #3d63c6;
    }

    button.secondary {
      background: #e1e7ff;
      color: #21409a;
    }

    .question-text {
      margin-top: 4px;
      font-size: 16px;
      text-align: center;
      margin-bottom: 10px;
    }

    .array-wrapper {
      background: #f0f4ff;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      border: 1px dashed #c1cffc;
    }

    .array-label {
      font-size: 14px;
      margin-bottom: 6px;
      text-align: center;
      color: #444;
    }

    .dot-grid {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
    }

    .dot-row {
      display: flex;
      gap: 6px;
      justify-content: center;
    }

    .dot {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ffffff, #ffd76f);
      border: 1px solid #f1b250;
      box-shadow: 0 1px 2px rgba(0,0,0,0.15);
    }

    .equation {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin: 12px 0;
      font-size: 18px;
      flex-wrap: wrap;
    }

    .equation span.factor {
      font-weight: 700;
      font-size: 22px;
      color: #2d3436;
    }

    .equation span.symbol {
      font-size: 18px;
    }

    .equation input {
      width: 80px;
      padding: 6px 8px;
      font-size: 16px;
      text-align: center;
      border-radius: 8px;
      border: 1px solid #cbd5f5;
      outline: none;
    }

    .equation input:focus {
      border-color: #4b7bec;
      box-shadow: 0 0 0 2px rgba(75, 123, 236, 0.2);
    }

    .feedback {
      text-align: center;
      font-size: 15px;
      min-height: 22px;
      margin-top: 4px;
    }

    .feedback.ok {
      color: #27ae60;
      font-weight: 600;
    }

    .feedback.bad {
      color: #e74c3c;
      font-weight: 600;
    }

    .answer-reveal {
      text-align: center;
      font-size: 14px;
      color: #555;
      margin-top: 4px;
      min-height: 18px;
    }

    .hint {
      font-size: 13px;
      color: #777;
      text-align: center;
      margin-top: 0;
      min-height: 18px;
    }

    @media (max-width: 480px) {
      .game-wrapper {
        margin-top: 20px;
        padding: 18px 16px 20px;
      }
      .equation span.factor {
        font-size: 20px;
      }
      .dot {
        width: 18px;
        height: 18px;
      }
    }
  </style>
</head>
<body>
  <div class="game-wrapper">
    <h1>ä¹˜æ³•å°é»é»</h1>
    <div class="subtitle" id="subtitle">
      çœ‹åœ“çƒé™£åˆ—ï¼Œæƒ³ä¸€æƒ³ï¼šå¹¾æ’ Ã— æ¯æ’å¹¾å€‹ï¼Ÿ
    </div>

    <div class="stats">
      å·²ç­”å°ï¼š<span id="correct-count">0</span> é¡Œ ï¼ ç¸½é¡Œæ•¸ï¼š<span id="total-count">0</span>
    </div>

    <!-- â­ / å‹³ç«  å€ -->
    <div class="reward-panel">
      <div class="reward-row">
        <span class="reward-label">æ˜Ÿæ˜Ÿä»»å‹™ï¼š</span>
        <div class="star-track" id="star-track"></div>
        <span class="star-count-text" id="star-count-text">0 / 2</span>
      </div>
      <div class="reward-row">
        <span class="reward-label">å‹•ç‰©å‹³ç« ï¼š</span>
        <span class="badge-list" id="badge-list">
          <span class="badge-empty">é‚„æ²’æœ‰ï¼Œæ…¢æ…¢æ”¶é›†ï½</span>
        </span>
      </div>
    </div>

    <div id="question-text" class="question-text">
      æŒ‰ã€Œä¸‹ä¸€é¡Œã€é–‹å§‹ç·´ç¿’ï¼
    </div>

    <!-- å¼å­ + æ§åˆ¶éµ -->
    <div class="equation">
      <span id="factor-a" class="factor">?</span>
      <span class="symbol">Ã—</span>
      <span id="factor-b" class="factor">?</span>
      <span class="symbol">=</span>
      <input id="answer-input" type="number" placeholder="ï¼Ÿ" />
      <button id="speak-btn" class="secondary" title="æœ—è®€é¡Œç›®">ğŸ”Š</button>
      <button id="check-btn">â˜‘ï¸æª¢æŸ¥</button>
      <button id="new-question-btn">â©Next</button>
    </div>

    <div class="array-wrapper">
      <div id="array-label" class="array-label"></div>
      <div id="dot-grid" class="dot-grid"></div>
    </div>

    <div id="hint" class="hint">
      å°æç¤ºï¼šå¯ä»¥å…ˆæ•¸ã€Œæ’æ•¸ã€ï¼Œå†æ•¸ã€Œæ¯æ’å¹¾é¡†ã€ï¼Œæœ€å¾ŒæŠŠå®ƒå€‘ç›¸ä¹˜ã€‚
    </div>

    <div id="feedback" class="feedback"></div>
    <div id="answer-reveal" class="answer-reveal"></div>

    <!-- æ¨¡å¼ï¼†é›£åº¦ -->
    <div class="mode-switch">
      <button class="mode-btn active" data-mode="area" id="mode-area">
        ğŸŸ¢ğŸŸ¢é¢ç©æ¨¡å¼
      </button>
      <button class="mode-btn" data-mode="groupColor" id="mode-group">
        ğŸ”´ğŸŸ¢é¡è‰²åˆ†çµ„æ¨¡å¼ï¼ˆå¹¾å€‹ä¸€æ•¸ï¼‰
      </button>
    </div>

    <div class="mode-switch" style="margin-top:4px;">
      <button class="mode-btn active" data-difficulty="easy" id="difficulty-easy">
        ğŸŸ¢æ™®é€šï¼ˆ1~5ï¼‰
      </button>
      <button class="mode-btn" data-difficulty="hard" id="difficulty-hard">
        ğŸ”´å›°é›£ï¼ˆ1~9ï¼‰
      </button>
    </div>

    <div class="controls">
      <button id="show-answer-btn" class="secondary">ANSWER ç­”æ¡ˆ</button>
    </div>
  </div>

  <script>
    // === ç‹€æ…‹ ===
    let currentA = null;
    let currentB = null;
    let correctCount = 0;
    let totalCount = 0;
    let currentMode = 'area';
    let currentDifficulty = 'easy';
    let currentQuestionAnsweredCorrect = false;
    let autoNextTimer = null;   // ç­”å°å¾Œè‡ªå‹•ä¸‹ä¸€é¡Œç”¨çš„è¨ˆæ™‚å™¨

    // gamification
    let starProgress = 0;
    const animalBadgeDefs = [
      { icon: 'ğŸ­', name: 'å°è€é¼ ' },
      { icon: 'ğŸ°', name: 'å°å…”å­' },
      { icon: 'ğŸ±', name: 'å°è²“å’ª' },
      { icon: 'ğŸ¶', name: 'å°ç‹—ç‹—' },
      { icon: 'ğŸ¯', name: 'å°è€è™' },
      { icon: 'ğŸ»', name: 'å°ç†Šç†Š' },
      { icon: 'ğŸ¦', name: 'å°ç…å­' },
      { icon: 'ğŸ˜', name: 'å°å¤§è±¡' },
      { icon: 'ğŸ¦’', name: 'å°é•·é ¸é¹¿' },
      { icon: 'ğŸ³', name: 'å°é¯¨é­š' }
    ];
    let earnedBadges = [];

    const dotGridEl = document.getElementById('dot-grid');
    const arrayLabelEl = document.getElementById('array-label');
    const factorAEl = document.getElementById('factor-a');
    const factorBEl = document.getElementById('factor-b');
    const questionTextEl = document.getElementById('question-text');
    const answerInputEl = document.getElementById('answer-input');
    const feedbackEl = document.getElementById('feedback');
    const answerRevealEl = document.getElementById('answer-reveal');
    const correctCountEl = document.getElementById('correct-count');
    const totalCountEl = document.getElementById('total-count');
    const subtitleEl = document.getElementById('subtitle');
    const hintEl = document.getElementById('hint');

    const newQuestionBtn = document.getElementById('new-question-btn');
    const checkBtn = document.getElementById('check-btn');
    const showAnswerBtn = document.getElementById('show-answer-btn');
    const modeAreaBtn = document.getElementById('mode-area');
    const modeGroupBtn = document.getElementById('mode-group');
    const speakBtn = document.getElementById('speak-btn');
    const difficultyEasyBtn = document.getElementById('difficulty-easy');
    const difficultyHardBtn = document.getElementById('difficulty-hard');

    const starTrackEl = document.getElementById('star-track');
    const starCountTextEl = document.getElementById('star-count-text');
    const badgeListEl = document.getElementById('badge-list');

    // ä¾ç›®å‰å¾½ç« æ•¸æ±ºå®šç•¶å‰æ˜Ÿæ˜Ÿé–€æª»
    function getStarGoal() {
      const badgeCount = earnedBadges.length;
      if (badgeCount === 0) return 2;
      if (badgeCount === 1) return 3;
      if (badgeCount === 2) return 4;
      return 6;
    }

    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    // åˆå§‹åŒ–æ˜Ÿæ˜Ÿåˆ—
    function initStarTrack() {
      const goal = getStarGoal();
      starTrackEl.innerHTML = '';
      for (let i = 0; i < goal; i++) {
        const span = document.createElement('span');
        span.className = 'star';
        span.textContent = 'â˜…';
        starTrackEl.appendChild(span);
      }
      updateStarDisplay();
    }

    function updateStarDisplay() {
      const goal = getStarGoal();
      const stars = starTrackEl.querySelectorAll('.star');
      stars.forEach((star, idx) => {
        star.classList.toggle('on', idx < starProgress);
      });
      starCountTextEl.textContent = `${Math.min(starProgress, goal)} / ${goal}`;
    }

    function updateBadgeDisplay() {
      if (earnedBadges.length === 0) {
        badgeListEl.innerHTML = '<span class="badge-empty">é‚„æ²’æœ‰ï¼Œæ…¢æ…¢æ”¶é›†ï½</span>';
      } else {
        badgeListEl.textContent = earnedBadges.map(b => b.icon).join(' ');
      }
    }

    function awardBadgeIfNeeded() {
      const goal = getStarGoal();
      if (starProgress >= goal) {
        starProgress = 0;
        const nextIndex = earnedBadges.length;
        const def = animalBadgeDefs[nextIndex] || { icon: 'ğŸ…', name: 'ç¥ç¥•å‹³ç« ' };
        earnedBadges.push(def);
        updateBadgeDisplay();

        // æ‹¿åˆ°ç¬¬ 5 æšå¾½ç« å¾Œï¼Œè‡ªå‹•åˆ‡æ›æˆå›°é›£æ¨¡å¼
        if (earnedBadges.length === 5) {
          currentDifficulty = 'hard';
          difficultyHardBtn.classList.add('active');
          difficultyEasyBtn.classList.remove('active');
        }

        feedbackEl.textContent = `æ­å–œç²å¾—å‹•ç‰©å‹³ç« ï¼š${def.icon} ${def.name}ï¼`;
        feedbackEl.className = 'feedback ok';

        // å¾½ç« æ•¸æ”¹è®Š â†’ é‡æ–°ä¾æ–°é–€æª»å»ºç«‹æ˜Ÿæ˜Ÿåˆ—
        initStarTrack();
      } else {
        updateStarDisplay();
      }
    }

    // ç•«é™£åˆ—
    function renderDotGrid(rows, cols) {
      dotGridEl.innerHTML = '';
      for (let r = 0; r < rows; r++) {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'dot-row';
        for (let c = 0; c < cols; c++) {
          const dot = document.createElement('div');
          dot.className = 'dot';
          rowDiv.appendChild(dot);
        }
        dotGridEl.appendChild(rowDiv);
      }
    }

    function renderDotGridGrouped(rows, cols) {
      dotGridEl.innerHTML = '';
      for (let r = 0; r < rows; r++) {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'dot-row';
        const hue = (r * 70) % 360;
        const fillColor = `hsl(${hue}, 90%, 80%)`;
        const borderColor = `hsl(${hue}, 70%, 50%)`;
        for (let c = 0; c < cols; c++) {
          const dot = document.createElement('div');
          dot.className = 'dot';
          dot.style.background = `radial-gradient(circle at 30% 30%, #ffffff, ${fillColor})`;
          dot.style.border = `1px solid ${borderColor}`;
          rowDiv.appendChild(dot);
        }
        dotGridEl.appendChild(rowDiv);
      }
    }

    // é¡Œç›®è¦–è¦º & æ–‡æœ¬
    function renderCurrentQuestionVisual() {
      if (currentA === null || currentB === null) {
        dotGridEl.innerHTML = '';
        arrayLabelEl.textContent = '';
        return;
      }

      const a = currentA;
      const b = currentB;

      if (currentMode === 'area') {
        renderDotGrid(a, b);
        arrayLabelEl.textContent =
          `é€™è£¡æœ‰ ${a} æ’ï¼Œæ¯æ’ ${b} é¡†çƒã€‚è«‹ç®—ä¸€ç®—ï¼š${a} Ã— ${b} ç­‰æ–¼å¤šå°‘ï¼Ÿ`;
        subtitleEl.textContent = 'çœ‹åœ“çƒé™£åˆ—ï¼Œæƒ³ä¸€æƒ³ï¼šå¹¾æ’ Ã— æ¯æ’å¹¾å€‹ï¼Ÿ';
        hintEl.textContent = 'å°æç¤ºï¼šå¯ä»¥å…ˆæ•¸ã€Œæ’æ•¸ã€ï¼Œå†æ•¸ã€Œæ¯æ’å¹¾é¡†ã€ï¼Œæœ€å¾ŒæŠŠå®ƒå€‘ç›¸ä¹˜ã€‚';
      } else {
        renderDotGridGrouped(a, b);
        arrayLabelEl.textContent =
          `é€™è£¡æœ‰ ${a} çµ„ï¼Œæ¯çµ„ ${b} é¡†çƒã€‚å¯ä»¥æƒ³æˆã€Œ${b} å€‹ä¸€æ•¸ã€ï¼Œæ•¸äº† ${a} æ¬¡ã€‚è«‹ç®—ä¸€ç®—ï¼š${a} Ã— ${b} ç­‰æ–¼å¤šå°‘ï¼Ÿ`;
        const seq = [];
        for (let i = 1; i <= a; i++) seq.push(i * b);
        subtitleEl.textContent = 'ç”¨é¡è‰²åˆ†çµ„ï¼Œçœ‹ä¸€çœ‹ï¼šæœ‰å¹¾çµ„ï¼Ÿæ¯çµ„å¹¾å€‹ï¼Ÿ';
        hintEl.textContent = `å°æç¤ºï¼šç”¨ã€Œ${b} å€‹ä¸€æ•¸ã€ä¾†æ•¸ï¼š` + seq.join('ã€') + 'ã€‚';
      }
    }

    function speakQuestion() {
      if (currentA === null || currentB === null) return;
      if (!('speechSynthesis' in window)) return;

      let text = '';
      if (currentMode === 'area') {
        text = `é€™è£¡æœ‰ ${currentA} æ’ï¼Œæ¯æ’ ${currentB} é¡†çƒã€‚` +
               `è«‹ç®—ä¸€ç®—ï¼š${currentA} æˆä»¥ ${currentB} ç­‰æ–¼å¤šå°‘ï¼Ÿ`;
      } else {
        text = `é€™è£¡æœ‰ ${currentA} çµ„ï¼Œæ¯çµ„ ${currentB} é¡†çƒã€‚` +
               `å¯ä»¥æƒ³æˆ ${currentB} å€‹ä¸€æ•¸ï¼Œæ•¸äº† ${currentA} æ¬¡ã€‚` +
               `è«‹ç®—ä¸€ç®—ï¼š${currentA} æˆä»¥ ${currentB} ç­‰æ–¼å¤šå°‘ï¼Ÿ`;
      }

      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = 'zh-TW';
      msg.rate = 0.95;

      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(msg);
    }

    // å‡ºæ–°é¡Œ
    function newQuestion() {
      // æ¸…æ‰å¯èƒ½å­˜åœ¨çš„è‡ªå‹•ä¸‹ä¸€é¡Œè¨ˆæ™‚å™¨
      if (autoNextTimer !== null) {
        clearTimeout(autoNextTimer);
        autoNextTimer = null;
      }

      const max = currentDifficulty === 'easy' ? 5 : 9;
      currentA = randomInt(1, max);
      currentB = randomInt(1, max);

      factorAEl.textContent = currentA;
      factorBEl.textContent = currentB;
      questionTextEl.textContent = '';

      answerInputEl.value = '';
      answerInputEl.focus();

      feedbackEl.textContent = '';
      feedbackEl.className = 'feedback';
      answerRevealEl.textContent = '';

      totalCount++;
      totalCountEl.textContent = totalCount;

      currentQuestionAnsweredCorrect = false;

      renderCurrentQuestionVisual();
      speakQuestion();
    }

    // æª¢æŸ¥ç­”æ¡ˆ
    function checkAnswer() {
      if (currentA === null || currentB === null) return;
      const userValue = parseInt(answerInputEl.value, 10);

      if (isNaN(userValue)) {
        feedbackEl.textContent = 'å…ˆè¼¸å…¥ä¸€å€‹æ•¸å­—å–”ï¼';
        feedbackEl.className = 'feedback bad';
        return;
      }

      const correct = currentA * currentB;

      if (userValue === correct) {
        if (!currentQuestionAnsweredCorrect) {
          currentQuestionAnsweredCorrect = true;

          feedbackEl.textContent = 'å¤ªæ£’äº†ï¼ç­”å° ğŸ‰';
          feedbackEl.className = 'feedback ok';

          correctCount++;
          correctCountEl.textContent = correctCount;

          // é¦–æ¬¡ç­”å°ï¼šåŠ ä¸€é¡†æ˜Ÿæ˜Ÿ
          starProgress++;
          awardBadgeIfNeeded();

          // 1 ç§’å¾Œè‡ªå‹•å‡ºä¸‹ä¸€é¡Œ
          autoNextTimer = setTimeout(() => {
            newQuestion();
          }, 1000);
        } else {
          feedbackEl.textContent = 'é€™é¡Œä½ å·²ç¶“ç­”å°å›‰ ğŸ‰';
          feedbackEl.className = 'feedback ok';
        }
      } else {
        feedbackEl.textContent = 'å†æƒ³æƒ³çœ‹ï¼Œå¯ä»¥æ•¸ä¸€æ•¸é»é»ï½';
        feedbackEl.className = 'feedback bad';
      }
    }

    function showAnswer() {
      if (currentA === null || currentB === null) return;
      const correct = currentA * currentB;
      answerRevealEl.textContent = `æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${currentA} Ã— ${currentB} = ${correct}`;
    }

    function setMode(mode) {
      if (mode !== 'area' && mode !== 'groupColor') return;
      currentMode = mode;
      modeAreaBtn.classList.toggle('active', mode === 'area');
      modeGroupBtn.classList.toggle('active', mode === 'groupColor');
      renderCurrentQuestionVisual();
      speakQuestion();
    }

    // ç¶å®šäº‹ä»¶
    newQuestionBtn.addEventListener('click', newQuestion);
    checkBtn.addEventListener('click', checkAnswer);
    showAnswerBtn.addEventListener('click', showAnswer);
    speakBtn.addEventListener('click', speakQuestion);

    answerInputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') checkAnswer();
    });

    modeAreaBtn.addEventListener('click', () => setMode('area'));
    modeGroupBtn.addEventListener('click', () => setMode('groupColor'));

    difficultyEasyBtn.addEventListener('click', () => {
      currentDifficulty = 'easy';
      difficultyEasyBtn.classList.add('active');
      difficultyHardBtn.classList.remove('active');
      newQuestion();
    });

    difficultyHardBtn.addEventListener('click', () => {
      currentDifficulty = 'hard';
      difficultyHardBtn.classList.add('active');
      difficultyEasyBtn.classList.remove('active');
      newQuestion();
    });

    // åˆå§‹åŒ– & ç¬¬ä¸€é¡Œ
    initStarTrack();
    updateBadgeDisplay();
    newQuestion();
  </script>
</body>
</html>
